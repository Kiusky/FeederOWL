<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>PLANETA X</title>
    <link rel="stylesheet" href="comand/iptv/styles.css">
    <!-- Clappr + HLSJS -->
    <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clappr-playback-hlsjs@latest/dist/clappr-playback-hlsjs.min.js"></script>
</head>
<body>

<!-- APP PRINCIPAL -->
<div id="app" class="app-container">
    <div class="header">
        <h1>
            <span class="app-logo">PLANETA X</span>
        </h1>
        <div id="exp-date-top" class="expiration-date"></div>
    </div>

    <!-- Menu de navega√ß√£o -->
    <div class="menu-topo">
        <button onclick="voltarHome()" class="home-button">üè† Home</button>
        <button onclick="filtrarTipo('Canais')">Canais</button>
        <button onclick="filtrarTipo('Filmes')">Filmes</button>
        <button onclick="filtrarTipo('S√©ries')">S√©ries</button>
        <button onclick="toggleBusca()" class="search-button">üîç Buscar</button>
    </div>

    <div id="busca-container" class="search-container">
        <input id="busca" oninput="filtrarBusca()" placeholder="üîç Buscar..." class="search-input"/>
    </div>

    <div id="player-area" class="player-area">
        <div id="player-container"></div>
        <div class="player-title"></div>
        <div class="autoplay-toggle"></div>
        <div class="player-controls">
            <button onclick="voltarEpisodio()">‚èÆ Anterior</button>
            <button onclick="proximoEpisodio()">Pr√≥ximo ‚è≠</button>
        </div>
    </div>
    
    <div id="episodios-area" class="episodes-area"></div>
    <div id="conteudo"></div>
</div>

<!-- MODAL DE QUALIDADES -->
<div id="modalQualidade" class="quality-modal">
    <div class="modal-content">
        <img alt="" id="modalImg" src="" class="modal-image"/>
        <h2 id="modalTitulo" class="modal-title"></h2>
        <div id="modalSinopse" class="modal-synopsis"></div>
        <button onclick="tocar(linkFHD, modalTitulo.innerText + ' (FHD)')" class="quality-button fhd">FHD</button>
        <button onclick="tocar(linkHD, modalTitulo.innerText + ' (HD)')" class="quality-button hd">HD</button>
        <button onclick="tocar(linkSD, modalTitulo.innerText + ' (SD)')" class="quality-button sd">SD</button>
        <br/><br/>
        <button onclick="fecharModal()" class="close-button">Fechar</button>
    </div>
</div>

<!-- SPLASH -->
<div id="splash" class="splash-screen">
    <img alt="Logo" src="https://i.imgur.com/BG5SmGQ.png" class="splash-logo"/>
    <div class="loader"></div>
</div>

<!-- RODAP√â -->
<div class="footer">
    ü™êPlaneta X - (77) 999827674
</div>

<script>
// Vari√°veis globais
let todos = [], player = null, info = {};
let linkFHD = "", linkHD = "", linkSD = "";
let itemAtualReproduzindo = null;
let autoplayEnabled = true;
let episodiosLista = [];
let episodioAtualIndex = -1;
let serieNomeAtual = "";

// Configura√ß√µes autom√°ticas
info = {
    servidor: "http://bestplaycdn.top:80",
    usuario: "4558281303",
    senha: "4354284746"
};

// TOGGLE BUSCA
function toggleBusca() {
    const buscaContainer = document.getElementById("busca-container");
    buscaContainer.style.display = buscaContainer.style.display === "none" ? "block" : "none";
    
    if (buscaContainer.style.display === "block") {
        document.getElementById("busca").focus();
    } else {
        document.getElementById("busca").value = "";
        voltarHome();
    }
}

// CARREGAR API
async function carregarAPI() {
    const token = `username=${info.usuario}&password=${info.senha}`;
    const base = `${info.servidor}/player_api.php?${token}`;
    
    try {
        document.getElementById("conteudo").innerHTML = "<div style='text-align:center; margin-top:50px;'>üîÑ Carregando conte√∫do...</div>";

        const [auth, vods, series, lives] = await Promise.all([
            fetch(base).then(r => r.json()),
            fetch(base + "&action=get_vod_streams").then(r => r.json()),
            fetch(base + "&action=get_series").then(r => r.json()),
            fetch(base + "&action=get_live_streams").then(r => r.json())
        ]);
        
        if (!auth || auth.user_info?.status !== "Active") throw new Error("Usu√°rio inativo.");

        const exp = new Date(parseInt(auth.user_info.exp_date) * 1000);
        const expStr = exp.toLocaleDateString();
        document.getElementById("exp-date-top").innerText = "vencimento: " + expStr;

        todos = [];

        lives.forEach(c => {
            todos.push({
                nome: c.name,
                logo: c.stream_icon,
                link: `${info.servidor}/live/${info.usuario}/${info.senha}/${c.stream_id}.m3u8`,
                tipo: "Canais | " + (c.category_name || "üì∫")
            });
        });

        vods.forEach(c => {
            todos.push({
                nome: c.name,
                logo: c.stream_icon || c.cover,
                link: `${info.servidor}/movie/${info.usuario}/${info.senha}/${c.stream_id}.mp4`,
                tipo: "Filmes | " + (c.category_name || "üéû"),
                vod_id: c.stream_id
            });
        });

        series.forEach(c => {
            todos.push({
                nome: c.name,
                logo: c.cover,
                serie_id: c.series_id,
                tipo: "S√©ries | " + (c.category_name || "üé¨")
            });
        });

        document.getElementById("app").style.display = "block";
        renderCarrosseis();

    } catch (e) {
        console.error(e);
        alert("Erro ao carregar dados da API: " + e.message);
    }
}

// RENDER CARROSSEIS
function renderCarrosseis() {
    const div = document.getElementById("conteudo");
    const grupos = {};
    
    todos.forEach(item => {
        if (!grupos[item.tipo]) grupos[item.tipo] = [];
        grupos[item.tipo].push(item);
    });
    
    div.innerHTML = Object.keys(grupos).map(tipo => {
        const cards = grupos[tipo].slice(0, 10).map(c => {
            const acao = c.serie_id
                ? `abrirSerieDetalhe(${c.serie_id}, '${c.nome.replace(/'/g, "")}')`
                : `abrirQualidades('${c.nome.replace(/'/g, "")}', '${c.logo}', '${c.link}', '${c.link}', '${c.link}', '${c.vod_id || ""}')`;
            return `<div class="card">
                <img src="${c.logo || 'https://via.placeholder.com/120x150'}" loading="lazy" onclick="${acao}">
                <p>${c.nome}</p>
            </div>`;
        }).join('');
        
        return `<div class="section">
            <h3>${tipo}
                <span onclick="verMais('${tipo}')" style="cursor:pointer; font-size:0.8em; color:#ccc;">Ver Mais</span>
            </h3>
            <div class="scroll-horizontal">${cards}</div>
        </div>`;
    }).join('');
    
    if (itemAtualReproduzindo) {
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            if (card.querySelector('p')?.textContent === itemAtualReproduzindo.nome) {
                card.classList.add('playing');
            }
        });
    }
}

// VER MAIS
function verMais(tipo) {
    if (player) player.destroy(); player = null;
    document.getElementById("player-area").style.display = "none";
    document.getElementById("episodios-area").style.display = "none";
    document.getElementById("busca-container").style.display = "none";
    
    const filtrado = todos.filter(c => c.tipo === tipo);
    const html = filtrado.map(c => {
        const acao = c.serie_id
            ? `abrirSerieDetalhe(${c.serie_id}, '${c.nome.replace(/'/g, "")}')`
            : `abrirQualidades('${c.nome.replace(/'/g, "")}', '${c.logo}', '${c.link}', '${c.link}', '${c.link}', '${c.vod_id || ""}')`;
        return `<div class="card">
            <img src="${c.logo || 'https://via.placeholder.com/120x150'}" loading="lazy" onclick="${acao}">
            <p>${c.nome}</p>
        </div>`;
    }).join('');
    
    document.getElementById("conteudo").innerHTML = `
        <div class="section">
            <h3>${tipo}
                <button onclick="renderCarrosseis()" style="padding:5px 10px; background:#ff3333; border:none; border-radius:5px; font-weight:bold; margin-left:10px;">‚Üê Voltar</button>
            </h3>
            <div class="scroll-horizontal" style="flex-wrap:wrap;">${html}</div>
        </div>`;
    
    if (itemAtualReproduzindo) {
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            if (card.querySelector('p')?.textContent === itemAtualReproduzindo.nome) {
                card.classList.add('playing');
            }
        });
    }
}

// ABRIR S√âRIE DETALHE
async function abrirSerieDetalhe(serieId, nome) {
    try {
        serieNomeAtual = nome;
        document.getElementById("episodios-area").style.display = "block";
        document.getElementById("busca-container").style.display = "none";
        const area = document.getElementById("episodios-area");
        area.innerHTML = `<div style='color:gray; font-size:20px; font-weight:bold;'>${nome}</div><div style='color:#ccc;'>üîÑ Carregando...</div>`;

        const res = await fetch(`${info.servidor}/player_api.php?username=${info.usuario}&password=${info.senha}&action=get_series_info&series_id=${serieId}`);
        const json = await res.json();
        const temporadas = json.episodes || {};
        const temporadasKeys = Object.keys(temporadas).sort((a,b)=>a-b);

        episodiosLista = [];
        temporadasKeys.forEach(temp => {
            episodiosLista = episodiosLista.concat(temporadas[temp].sort((a,b) => a.episode_num - b.episode_num));
        });

        if (episodiosLista.length > 0) {
            const primeiro = episodiosLista[0];
            const urlPrimeiro = `${info.servidor}/series/${info.usuario}/${info.senha}/${primeiro.id}.mp4`;
            const titulo = `Ep ${primeiro.episode_num}: ${primeiro.title}`;
            episodioAtualIndex = 0;
            tocar(urlPrimeiro, `${nome} - ${titulo}`);
        }

        let html = `<img src="${json.info.cover}" style="width:150px; border-radius:10px; margin:10px 0;" alt="Capa"/>`;
        html += `<div style='margin:10px 0;'>${json.info.plot || "Sem descri√ß√£o."}</div>`;
        html += `<button onclick="toggleEpisodios()" class="btn-episodios-toggle">üìÇ Epis√≥dios</button>`;
        html += `<div id="listaEpisodios" style="display:none;">`;

        temporadasKeys.forEach(temp => {
            html += `<div style='color:#ffcc00; margin-top:10px; font-weight:bold;'>Temporada ${temp}</div>`;
            html += `<div style='display:flex; flex-wrap:wrap;'>`;
            temporadas[temp].sort((a,b)=>a.episode_num - b.episode_num).forEach(ep => {
                const titulo = `Ep ${ep.episode_num}: ${ep.title}`;
                const url = `${info.servidor}/series/${info.usuario}/${info.senha}/${ep.id}.mp4`;
                html += `<button class="episodio-btn" onclick="tocar('${url}', '${nome} - ${titulo}')">${titulo}</button>`;
            });
            html += `</div>`;
        });

        html += `</div>`;
        area.innerHTML = html;
    } catch(e) {
        console.error(e);
        alert("Erro ao carregar s√©rie.");
    }
}

// Alternar Epis√≥dios
function toggleEpisodios() {
    const lista = document.getElementById("listaEpisodios");
    lista.style.display = (lista.style.display === "none") ? "block" : "none";
}

// PLAYER COM CONTROLES OCULTOS
function tocar(url, nome = '') {
    if (!url) return alert("Sem link dispon√≠vel.");
    if (player) player.destroy();
    
    document.querySelectorAll('.card.playing').forEach(card => {
        card.classList.remove('playing');
    });
    
    itemAtualReproduzindo = { url, nome };
    const playerArea = document.getElementById("player-area");
    playerArea.style.display = "block";
    playerArea.classList.add("player-visible");
    
    document.getElementById("player-area").innerHTML = `
        <div id="player-container"></div>
        <div class="player-title">${nome}</div>
        <div class="autoplay-toggle ${autoplayEnabled ? 'active' : ''}" onclick="toggleAutoplay()">
            Autoplay: ${autoplayEnabled ? 'ON' : 'OFF'}
        </div>
        <div class="player-controls">
            <button onclick="voltarEpisodio()">‚èÆ Anterior</button>
            <button onclick="proximoEpisodio()">Pr√≥ximo ‚è≠</button>
        </div>
    `;
    
    player = new Clappr.Player({
        parentId: "#player-container",
        source: url,
        autoPlay: true,
        width: "100%",
        height: "100%",
        events: {
            onReady: function () {
                const salvo = parseFloat(localStorage.getItem("progresso_" + url) || "0");
                if (salvo > 0) setTimeout(() => player.seek(salvo), 1000);
                
                if (nome) {
                    const cards = document.querySelectorAll('.card');
                    cards.forEach(card => {
                        if (card.querySelector('p')?.textContent === nome.split(' - ')[0]) {
                            card.classList.add('playing');
                        }
                    });
                }
            },
            onTimeUpdate: function (e) {
                if (e && e.current) {
                    localStorage.setItem("progresso_" + url, e.current);
                    localStorage.setItem("duracao_" + url, e.total);
                }
            },
            onEnded: function() {
                if (autoplayEnabled && episodiosLista.length > 0 && episodioAtualIndex >= 0) {
                    proximoEpisodio();
                }
            },
            onError: () => {
                window.location.href = `intent:${url}#Intent;package=org.videolan.vlc;type=video/*;end;`;
            }
        }
    });
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
    fecharModal();
}

// Fun√ß√£o para alternar o autoplay
function toggleAutoplay() {
    autoplayEnabled = !autoplayEnabled;
    const toggleBtn = document.querySelector('.autoplay-toggle');
    if (toggleBtn) {
        toggleBtn.classList.toggle('active');
        toggleBtn.textContent = `Autoplay: ${autoplayEnabled ? 'ON' : 'OFF'}`;
    }
}

// Fun√ß√£o para ir para o pr√≥ximo epis√≥dio
function proximoEpisodio() {
    if (episodiosLista.length === 0 || episodioAtualIndex === -1) return;
    
    const nextIndex = episodioAtualIndex + 1;
    if (nextIndex >= episodiosLista.length) return;
    
    const nextEp = episodiosLista[nextIndex];
    const url = `${info.servidor}/series/${info.usuario}/${info.senha}/${nextEp.id}.mp4`;
    const titulo = `Ep ${nextEp.episode_num}: ${nextEp.title}`;
    
    episodioAtualIndex = nextIndex;
    tocar(url, `${serieNomeAtual} - ${titulo}`);
}

// Fun√ß√£o para voltar ao epis√≥dio anterior
function voltarEpisodio() {
    if (episodiosLista.length === 0 || episodioAtualIndex === -1) return;
    
    const prevIndex = episodioAtualIndex - 1;
    if (prevIndex < 0) return;
    
    const prevEp = episodiosLista[prevIndex];
    const url = `${info.servidor}/series/${info.usuario}/${info.senha}/${prevEp.id}.mp4`;
    const titulo = `Ep ${prevEp.episode_num}: ${prevEp.title}`;
    
    episodioAtualIndex = prevIndex;
    tocar(url, `${serieNomeAtual} - ${titulo}`);
}

// MODAL QUALIDADES COM SINOPSE
async function abrirQualidades(nome, img, fhd, hd, sd, vodId) {
    document.getElementById("modalTitulo").innerText = nome;
    document.getElementById("modalImg").src = img || 'https://via.placeholder.com/120x150';
    linkFHD = fhd; linkHD = hd; linkSD = sd;
    document.getElementById("modalSinopse").innerText = "üîÑ Carregando sinopse...";
    
    if (vodId) {
        try {
            const res = await fetch(`${info.servidor}/player_api.php?username=${info.usuario}&password=${info.senha}&action=get_vod_info&vod_id=${vodId}`);
            const json = await res.json();
            const sinopse = json.info?.plot || "Sem descri√ß√£o dispon√≠vel.";
            document.getElementById("modalSinopse").innerText = sinopse;
        } catch {
            document.getElementById("modalSinopse").innerText = "Erro ao carregar sinopse.";
        }
    } else {
        document.getElementById("modalSinopse").innerText = "";
    }
    
    document.getElementById("modalQualidade").style.display = "flex";
}

function fecharModal() {
    document.getElementById("modalQualidade").style.display = "none";
}

// FILTRAR TIPO
function filtrarTipo(tipo) {
    if (player) player.destroy(); player = null;
    document.getElementById("player-area").style.display = "none";
    document.getElementById("episodios-area").style.display = "none";
    document.getElementById("busca-container").style.display = "none";
    
    const filtrado = todos.filter(c => c.tipo.includes(tipo));
    const html = filtrado.map(c => {
        const acao = c.serie_id
            ? `abrirSerieDetalhe(${c.serie_id}, '${c.nome.replace(/'/g, "")}')`
            : `abrirQualidades('${c.nome.replace(/'/g, "")}', '${c.logo}', '${c.link}', '${c.link}', '${c.link}', '${c.vod_id || ""}')`;
        return `<div class="card">
            <img src="${c.logo || 'https://via.placeholder.com/120x150'}" loading="lazy" onclick="${acao}">
            <p>${c.nome}</p>
        </div>`;
    }).join('');
    
    document.getElementById("conteudo").innerHTML = `<div class="scroll-horizontal" style="flex-wrap:wrap;">${html}</div>`;
    
    if (itemAtualReproduzindo) {
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            if (card.querySelector('p')?.textContent === itemAtualReproduzindo.nome.split(' - ')[0]) {
                card.classList.add('playing');
            }
        });
    }
}

// BUSCA
function filtrarBusca() {
    if (player) player.destroy(); player = null;
    document.getElementById("player-area").style.display = "none";
    document.getElementById("episodios-area").style.display = "none";
    
    const termo = document.getElementById("busca").value.toLowerCase();
    const filtrado = todos.filter(c => c.nome.toLowerCase().includes(termo));
    const html = filtrado.map(c => {
        const acao = c.serie_id
            ? `abrirSerieDetalhe(${c.serie_id}, '${c.nome.replace(/'/g, "")}')`
            : `abrirQualidades('${c.nome.replace(/'/g, "")}', '${c.logo}', '${c.link}', '${c.link}', '${c.link}', '${c.vod_id || ""}')`;
        return `<div class="card">
            <img src="${c.logo || 'https://via.placeholder.com/120x150'}" loading="lazy" onclick="${acao}">
            <p>${c.nome}</p>
        </div>`;
    }).join('');
    
    document.getElementById("conteudo").innerHTML = `<div class="scroll-horizontal" style="flex-wrap:wrap;">${html}</div>`;
    
    if (itemAtualReproduzindo) {
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            if (card.querySelector('p')?.textContent === itemAtualReproduzindo.nome.split(' - ')[0]) {
                card.classList.add('playing');
            }
        });
    }
}

// VOLTAR HOME
function voltarHome() {
    if (player) player.destroy(); player = null;
    document.getElementById("player-area").style.display = "none";
    document.getElementById("episodios-area").style.display = "none";
    document.getElementById("busca").value = "";
    document.getElementById("busca-container").style.display = "none";
    renderCarrosseis();
}

// Verifica e marca o item sendo reproduzido quando a p√°gina √© rolada
window.addEventListener('scroll', () => {
    if (itemAtualReproduzindo) {
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            card.classList.remove('playing');
            if (card.querySelector('p')?.textContent === itemAtualReproduzindo.nome.split(' - ')[0]) {
                card.classList.add('playing');
            }
        });
    }
});

// Inicia automaticamente quando a p√°gina carrega
window.onload = () => {
    document.getElementById("splash").style.display = "none";
    carregarAPI();
};
</script>
</body>
</html>